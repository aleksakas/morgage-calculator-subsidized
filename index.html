<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mortgage (2-phase) + Premature Payments</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111826;
      --border:#223043;
      --muted:#9aa4b2;
      --ink:#e6edf3;
      --field:#0f1724;
      --fieldBorder:#24344c;
      --accent:#66e3ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      overflow:hidden; /* ✅ whole page not scrollable */
    }

    .wrap{
      height:100vh;
      max-width:1200px;
      margin:0 auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:var(--card);
      border-radius:14px;
      flex:0 0 auto;
    }
    .title{
      font-weight:700;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:3px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:10px;
      min-height:0;
    }

    /* For small screens, allow normal scroll (otherwise it's impossible) */
    @media(max-width:980px){
      body{overflow:auto;}
      .wrap{height:auto; min-height:100vh;}
      .grid{grid-template-columns:1fr;}
      .title{white-space:normal}
    }

    .panel{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:14px;
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      margin-bottom:6px;
      flex:0 0 auto;
    }
    .sectionHead h2{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      text-transform:uppercase;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      flex:0 0 auto;
    }
    .field{
      border:1px solid var(--fieldBorder);
      background:var(--field);
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .field label{
      font-size:11px;
      color:var(--muted);
    }
    .field input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--ink);
      font-size:13px;
      padding:0;
      min-width:0;
    }
    .field:focus-within{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(102,227,255,.12);
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      flex:0 0 auto;
    }
    button{
      border:1px solid var(--fieldBorder);
      background:var(--field);
      color:var(--ink);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{border-color:var(--accent)}
    button.primary{border-color:rgba(102,227,255,.5)}
    button:disabled{opacity:.5; cursor:not-allowed}

    .hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      flex:0 0 auto;
    }
    .warn{color:#ffd36a}

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
      flex:0 0 auto;
    }
    @media(max-width:980px){
      .kpis{grid-template-columns:1fr}
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:linear-gradient(180deg,rgba(102,227,255,.08),rgba(102,227,255,0));
      min-width:0;
    }
    .kpi .t{font-size:11px;color:var(--muted);margin-bottom:4px}
    .kpi .v{font-size:16px;font-weight:800}
    .kpi .s{font-size:11px;color:var(--muted);margin-top:4px}

    .tableWrap{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
      flex:0 0 auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed;
    }
    thead th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:8px 10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .mono{font-variant-numeric:tabular-nums}

    .chip{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;
      padding:2px 10px;
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }

    .addRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:8px;
      align-items:stretch;
      flex:0 0 auto;
    }
    @media(max-width:980px){
      .addRow{grid-template-columns:1fr 1fr}
      .addRow button{grid-column:1 / -1}
    }

    .grow{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }

    /* ✅ Scroll ONLY inside the premature payments list */
    .ppScroll{
      height:220px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .ppScroll::-webkit-scrollbar{ width:10px; }
    .ppScroll::-webkit-scrollbar-thumb{ background:var(--border); border-radius:999px; }
    .ppScroll::-webkit-scrollbar-track{ background:transparent; }

    /* Keep impact table fixed; still no page scrolling.
       If you want impact scroll too, tell me and I’ll do it similarly. */
    .impFixed{ height:340px; overflow:hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Mortgage (2-phase) + Premature Payments</div>
      <div class="badge">Page locked • list scrolls only</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="sectionHead">
          <h2>Inputs</h2>
          <span class="chip" id="ratesChip">—</span>
        </div>

        <div class="formGrid">
          <div class="field">
            <label>Property price (EUR)</label>
            <input id="price" type="number" step="0.01" value="100000">
          </div>
          <div class="field">
            <label>Deposit (EUR)</label>
            <input id="deposit" type="number" step="0.01" value="1000">
          </div>
          <div class="field">
            <label>Years</label>
            <input id="years" type="number" step="1" value="40">
          </div>
          <div class="field">
            <label>Loan amount (auto)</label>
            <input id="loanAuto" type="text" readonly value="—">
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="calcBtn">Recalculate</button>
          <button id="resetBtn">Reset</button>
        </div>

        <div class="sectionHead" style="margin-top:6px">
          <h2>Premature payments</h2>
          <span class="chip" id="ppCount">0 items</span>
        </div>

        <div class="addRow">
          <div class="field">
            <label>Month</label>
            <input id="newMonth" type="number" step="1" min="1" placeholder="e.g. 12">
          </div>
          <div class="field">
            <label>Amount (EUR)</label>
            <input id="newAmount" type="number" step="0.01" min="0" placeholder="e.g. 1000">
          </div>
          <button id="addBtn">+ Add</button>
        </div>

        <div class="hint warn" id="validationOut"></div>

        <div class="grow">
          <div class="tableWrap ppScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:42px">#</th>
                  <th style="width:90px">Month</th>
                  <th class="right">Amount</th>
                  <th class="right" style="width:90px">Action</th>
                </tr>
              </thead>
              <tbody id="ppBody"></tbody>
            </table>
          </div>

          <div class="hint">
            This list scrolls. The rest of the page stays locked (no scrolling).
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="sectionHead">
          <h2>Baseline (no premature payments)</h2>
          <span class="chip" id="termChip">—</span>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Monthly payment (first 6 years)</div>
            <div class="v mono" id="p1Out">—</div>
            <div class="s mono" id="p1Sub">—</div>
          </div>
          <div class="kpi">
            <div class="t">Monthly payment (after 6 years)</div>
            <div class="v mono" id="p2Out">—</div>
            <div class="s mono" id="p2Sub">—</div>
          </div>
          <div class="kpi">
            <div class="t">Impact</div>
            <div class="v mono" id="deltaOut">—</div>
            <div class="s">See table below</div>
          </div>
        </div>

        <div class="sectionHead" style="margin-top:4px">
          <h2>Impact (cumulative per row)</h2>
          <span class="chip" id="impactChip">—</span>
        </div>

        <div class="grow">
          <div class="tableWrap impFixed">
            <table>
              <thead>
                <tr>
                  <th style="width:42px">#</th>
                  <th style="width:80px">Month</th>
                  <th class="right">Extra</th>
                  <th class="right">Bal. before</th>
                  <th class="right">Bal. after</th>
                  <th class="right">New payment</th>
                  <th class="right">After 6y</th>
                </tr>
              </thead>
              <tbody id="impactBody"></tbody>
            </table>
          </div>

          <div class="hint">
            Impact table is fixed-height (no page scroll). If you want this table scrollable too, say so.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const FIXED_ANNUAL_RATE = 0.015;
  const VAR_ANNUAL_RATE   = 0.0394;
  const FIXED_MONTHS      = 72;

  const $ = (id) => document.getElementById(id);

  let prepayments = [];

  function fmtEur(x){
    if(!isFinite(x)) return "—";
    return x.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " EUR";
  }
  function powInt(a,n){ let r=1; for(let i=0;i<n;i++) r*=a; return r; }
  function annuityPayment(principal, annualRate, months){
    if(months <= 0) return 0;
    const r = annualRate / 12;
    if(Math.abs(r) < 1e-15) return principal / months;
    const p = powInt(1 + r, months);
    return principal * (r * p) / (p - 1);
  }

  function computeLoan(){
    const price = +$("price").value || 0;
    const deposit = +$("deposit").value || 0;
    const years = Math.max(1, Math.floor(+$("years").value || 0));
    const termMonths = years * 12;

    const dep = Math.min(Math.max(deposit, 0), Math.max(price, 0));
    const loan = Math.max(0, price - dep);

    $("loanAuto").value = fmtEur(loan);
    $("termChip").textContent = `${years} years (${termMonths} months)`;

    return { loan, termMonths, years };
  }

  function cleanedSortedPrepayments(termMonths){
    const validation = [];
    const cleaned = prepayments
      .map(x => ({ month: Math.floor(+x.month || 0), amount: +x.amount || 0 }))
      .filter(x => x.month >= 1 && x.amount > 0);

    for(const p of cleaned){
      if(p.month > termMonths){
        validation.push(`Payment month ${p.month} is beyond term (${termMonths}) and will be ignored.`);
      }
    }

    const within = cleaned.filter(p => p.month <= termMonths);
    within.forEach((p, i) => p._i = i);
    within.sort((a,b) => (a.month - b.month) || (a._i - b._i));
    within.forEach(p => delete p._i);

    return { within, validation };
  }

  function simulateUpToK({loan, termMonths, prepayList, k}){
    const fixedMonths = Math.min(FIXED_MONTHS, termMonths);
    const events = prepayList.slice(0, k);

    let bal = loan;
    let payment = annuityPayment(bal, FIXED_ANNUAL_RATE, termMonths);

    let paymentAfter6 = null;

    const target = events[events.length - 1];
    let rowBefore = null, rowAfter = null, rowNewPayment = null;

    let eventIndex = 0;

    for(let m=1; m<=termMonths; m++){
      const inFixed = (m <= fixedMonths);
      const ar = inFixed ? FIXED_ANNUAL_RATE : VAR_ANNUAL_RATE;

      if(m === fixedMonths + 1){
        const remaining = termMonths - (m - 1);
        payment = remaining > 0 ? annuityPayment(bal, VAR_ANNUAL_RATE, remaining) : 0;
        paymentAfter6 = payment;
      }

      const r = ar / 12;
      const interest = bal * r;
      let principal = payment - interest;
      if(principal < 0) principal = 0;
      if(principal > bal) principal = bal;
      bal -= principal;

      while(eventIndex < events.length && events[eventIndex].month === m && bal > 0){
        const amount = events[eventIndex].amount;

        const beforeExtra = bal;
        const applied = Math.min(amount, bal);
        bal -= applied;

        const remainingMonths = termMonths - m;
        const newPayment = remainingMonths > 0 ? annuityPayment(bal, ar, remainingMonths) : 0;

        if(events[eventIndex] === target){
          rowBefore = beforeExtra;
          rowAfter = bal;
          rowNewPayment = newPayment;
        }

        payment = newPayment;
        eventIndex++;
      }

      if(bal <= 0) break;
    }

    if(termMonths > fixedMonths && paymentAfter6 === null){
      paymentAfter6 = 0;
    }

    return { rowBefore, rowAfter, rowNewPayment, paymentAfter6 };
  }

  function calcBaseline({loan, termMonths}){
    const fixedMonths = Math.min(FIXED_MONTHS, termMonths);
    const baseP1 = annuityPayment(loan, FIXED_ANNUAL_RATE, termMonths);

    let balAfterFixed = loan;
    for(let m=1; m<=fixedMonths; m++){
      const r = FIXED_ANNUAL_RATE / 12;
      const interest = balAfterFixed * r;
      let principal = baseP1 - interest;
      if(principal > balAfterFixed) principal = balAfterFixed;
      balAfterFixed -= principal;
    }

    const baselineRem = termMonths - fixedMonths;
    const baseP2 = baselineRem > 0 ? annuityPayment(balAfterFixed, VAR_ANNUAL_RATE, baselineRem) : 0;

    $("p1Out").textContent = fmtEur(baseP1);
    $("p1Sub").textContent = `Rate ${(FIXED_ANNUAL_RATE*100).toFixed(2)}% · First ${fixedMonths} months`;
    $("p2Out").textContent = baselineRem > 0 ? fmtEur(baseP2) : "—";
    $("p2Sub").textContent = baselineRem > 0
      ? `Rate ${(VAR_ANNUAL_RATE*100).toFixed(2)}% · Remaining ${baselineRem} months`
      : "No variable phase";
  }

  function renderPrepayList(list){
    $("ppCount").textContent = `${list.length} items`;

    const body = $("ppBody");
    body.innerHTML = "";

    if(list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="mono" style="color:var(--muted)">No premature payments yet.</td>`;
      body.appendChild(tr);
      return;
    }

    list.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${idx + 1}</td>
        <td class="mono">${p.month}</td>
        <td class="right mono">${fmtEur(p.amount)}</td>
        <td class="right"><button data-remove="${idx}">Remove</button></td>
      `;
      body.appendChild(tr);
    });

    body.querySelectorAll("button[data-remove]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = +e.target.dataset.remove;
        // remove from original prepayments by matching idx in cleaned list: easiest is rebuild prepayments from cleaned list after removal
        // We'll remove by value+position by reconstructing:
        const { termMonths } = computeLoan();
        const { within } = cleanedSortedPrepayments(termMonths);
        within.splice(idx, 1);
        prepayments = within.map(x => ({ month: x.month, amount: x.amount }));
        recalcAll();
      });
    });
  }

  function renderImpact(rows){
    $("impactChip").textContent = `${rows.length} rows`;

    const body = $("impactBody");
    body.innerHTML = "";

    if(rows.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="mono" style="color:var(--muted)">Add premature payments to see impact.</td>`;
      body.appendChild(tr);
      return;
    }

    rows.slice(0, 6).forEach(r => { // keep visible without scroll; increase if you want
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${r.k}</td>
        <td class="mono">${r.month}</td>
        <td class="right mono">${fmtEur(r.amount)}</td>
        <td class="right mono">${fmtEur(r.before)}</td>
        <td class="right mono">${fmtEur(r.after)}</td>
        <td class="right mono"><b>${fmtEur(r.newPay)}</b></td>
        <td class="right mono"><b>${fmtEur(r.after6)}</b></td>
      `;
      body.appendChild(tr);
    });

    $("deltaOut").textContent = rows.length ? "Per-row recalculated" : "—";
  }

  function recalcAll(){
    $("validationOut").textContent = "";

    const { loan, termMonths } = computeLoan();

    if(loan <= 0){
      $("p1Out").textContent = "—";
      $("p1Sub").textContent = "Loan amount is 0.";
      $("p2Out").textContent = "—";
      $("p2Sub").textContent = "";
      renderPrepayList([]);
      renderImpact([]);
      $("deltaOut").textContent = "—";
      return;
    }

    calcBaseline({loan, termMonths});

    const { within, validation } = cleanedSortedPrepayments(termMonths);
    if(validation.length){
      $("validationOut").textContent = validation.join(" ");
    }

    renderPrepayList(within);

    const rows = within.map((p, i) => {
      const k = i + 1;
      const sim = simulateUpToK({ loan, termMonths, prepayList: within, k });
      return {
        k,
        month: p.month,
        amount: p.amount,
        before: sim.rowBefore,
        after: sim.rowAfter,
        newPay: sim.rowNewPayment,
        after6: sim.paymentAfter6
      };
    });

    renderImpact(rows);
  }

  $("calcBtn").addEventListener("click", recalcAll);

  $("resetBtn").addEventListener("click", () => {
    $("price").value = 100000;
    $("deposit").value = 1000;
    $("years").value = 40;
    $("newMonth").value = "";
    $("newAmount").value = "";
    prepayments = [];
    recalcAll();
  });

  $("addBtn").addEventListener("click", () => {
    const { termMonths } = computeLoan();
    const month = Math.max(1, Math.floor(+$("newMonth").value || 0));
    const amount = Math.max(0, +$("newAmount").value || 0);

    if(!month || amount <= 0){
      $("validationOut").textContent = "Enter a valid month and amount.";
      return;
    }
    if(month > termMonths){
      $("validationOut").textContent = `Month ${month} is beyond the loan term (${termMonths}).`;
      return;
    }

    prepayments.push({ month, amount });
    $("newMonth").value = "";
    $("newAmount").value = "";

    // scroll the small list to bottom so the newly added row is visible
    setTimeout(() => {
      const el = document.querySelector(".ppScroll");
      if(el) el.scrollTop = el.scrollHeight;
    }, 0);

    recalcAll();
  });

  ["price","deposit","years"].forEach(id => $(id).addEventListener("input", recalcAll));

  $("ratesChip").textContent =
    `Fixed ${(FIXED_ANNUAL_RATE*100).toFixed(2)}% (${FIXED_MONTHS}m) → Variable ${(VAR_ANNUAL_RATE*100).toFixed(2)}%`;

  recalcAll();
})();
</script>
</body>
</html>
